# =============================================================================
# å›½ä¼šè­°äº‹éŒ²æ¤œç´¢ãƒ»åˆ†æã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
# =============================================================================
# 
# æ¦‚è¦:
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å›½ä¼šè­°äº‹éŒ²æ¤œç´¢ãƒ»åˆ†æã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚
# Streamlitã‚’ä½¿ç”¨ã—ã¦Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã—ã€å›½ä¼šè­°äº‹éŒ²APIã‚’æ´»ç”¨ã—ãŸ
# æ¤œç´¢ãƒ»åˆ†ææ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚
# 
# èª²é¡Œ2: Streamlitã‚’ä½¿ã£ãŸã‚¢ãƒ—ãƒªã®é–‹ç™º + å…¬é–‹
# å­¦ç±ç•ªå·: [å­¦ç±ç•ªå·]
# ä½œæˆè€…: [åå‰]
# ä½œæˆæ—¥: 2024å¹´8æœˆ
# 
# ä¸»è¦æ©Ÿèƒ½:
# - å›½ä¼šè­°äº‹éŒ²ã®é«˜åº¦ãªæ¤œç´¢æ©Ÿèƒ½
# - æ¤œç´¢çµæœã®çµ±è¨ˆåˆ†æãƒ»å¯è¦–åŒ–
# - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æãƒ»ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆ
# - æ¤œç´¢å±¥æ­´ã®ç®¡ç†ãƒ»ä¿å­˜
# 
# ä¾å­˜é–¢ä¿‚:
# - streamlit: Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
# - requests: HTTPé€šä¿¡
# - pandas: ãƒ‡ãƒ¼ã‚¿å‡¦ç†
# - plotly: ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–
# - janome: æ—¥æœ¬èªå½¢æ…‹ç´ è§£æï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
# - wordcloud: ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
# 
# é–‹ç™ºç’°å¢ƒ:
# - Anacondaä»®æƒ³ç’°å¢ƒ
# - Python 3.8+
# - Streamlit Cloudï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å…ˆï¼‰
# 
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.1.0
# =============================================================================

import streamlit as st
import requests
import time
import re
from datetime import date, datetime
import json
import pandas as pd
from collections import Counter
import plotly.express as px
import plotly.graph_objects as go
import os

# =============================================================================
# æ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®š
# =============================================================================
# 
# èª¬æ˜:
# ä¸€éƒ¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã§ã‚‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯å‹•ä½œã—ã¾ã™ã€‚
# å„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€é©åˆ‡ãªè­¦å‘Šã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

# Janomeï¼ˆæ—¥æœ¬èªå½¢æ…‹ç´ è§£æï¼‰ã®æ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒãƒ¼ãƒˆ
try:
    from janome.tokenizer import Tokenizer
    st.success("âœ… Janomeãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚å½¢æ…‹ç´ è§£ææ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚")
except ImportError:
    st.warning("âš ï¸ Janomeãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å½¢æ…‹ç´ è§£ææ©Ÿèƒ½ã¯ç„¡åŠ¹ã§ã™ã€‚")
    st.info("ğŸ’¡ å½¢æ…‹ç´ è§£ææ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯: pip install janome")

# WordCloudï¼ˆãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆï¼‰ã®æ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒãƒ¼ãƒˆ
try:
    from wordcloud import WordCloud
    import matplotlib.pyplot as plt
    import matplotlib.font_manager as fm
    import numpy as np
    st.success("âœ… WordCloudãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚")
except ImportError:
    st.warning("âš ï¸ WordCloudãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰æ©Ÿèƒ½ã¯ç„¡åŠ¹ã§ã™ã€‚")
    st.info("ğŸ’¡ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯: pip install wordcloud matplotlib")

# =============================================================================
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# =============================================================================
from components import show_sidebar
from logic import KokkaiSearchApp

# =============================================================================
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
# =============================================================================
# 
# ãƒšãƒ¼ã‚¸è¨­å®š:
# - page_title: ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¿ã‚¤ãƒˆãƒ«
# - page_icon: ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¢ã‚¤ã‚³ãƒ³
# - layout: ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆ"wide"ã§æ¨ªå¹…ã‚’æœ€å¤§æ´»ç”¨ï¼‰
# - initial_sidebar_state: ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®åˆæœŸçŠ¶æ…‹

st.set_page_config(
    page_title="å›½ä¼šè­°äº‹éŒ²æ¤œç´¢ã‚¢ãƒ—ãƒª",
    page_icon="ğŸ›ï¸",
    layout="wide",
    initial_sidebar_state="expanded"
)

# =============================================================================
# ã‚«ã‚¹ã‚¿ãƒ CSSã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
# =============================================================================
# 
# èª¬æ˜:
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¦‹ãŸç›®ã‚’æ”¹å–„ã™ã‚‹ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ CSSã‚’å®šç¾©ã—ã¾ã™ã€‚
# å„ã‚¯ãƒ©ã‚¹ã¯ç‰¹å®šã®UIè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

st.markdown("""
<style>
    /* ãƒ¡ã‚¤ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .main-header {
        font-size: 3rem;
        color: #1f4e79;
        text-align: center;
        margin-bottom: 2rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        font-weight: bold;
    }
    
    /* ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .sub-header {
        font-size: 1.5rem;
        color: #2e6da4;
        margin-bottom: 1rem;
        font-weight: 600;
    }
    
    /* ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .highlight-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 10px;
        color: white;
        margin: 20px 0;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .metric-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #1f4e79;
        margin: 10px 0;
    }
    
    /* ç™ºè¨€ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .speech-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #17a2b8;
        transition: all 0.3s ease;
    }
    
    .speech-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
</style>
""", unsafe_allow_html=True)

# =============================================================================
# ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
# =============================================================================

def load_search_history():
    """
    æ¤œç´¢å±¥æ­´ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€é–¢æ•°
    
    æ©Ÿèƒ½:
    - search_history.csvãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ¤œç´¢å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    - JSONå½¢å¼ã§ä¿å­˜ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¾æ›¸å½¢å¼ã«å¤‰æ›
    - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹å®‰å…¨ãªèª­ã¿è¾¼ã¿
    
    æˆ»ã‚Šå€¤:
    - list: æ¤œç´¢å±¥æ­´ã®ãƒªã‚¹ãƒˆï¼ˆè¾æ›¸å½¢å¼ï¼‰
    
    ã‚¨ãƒ©ãƒ¼å‡¦ç†:
    - ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆ: ç©ºã®ãƒªã‚¹ãƒˆã‚’è¿”ã™
    - èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã®å ´åˆ: è­¦å‘Šã‚’è¡¨ç¤ºã—ã¦ç©ºã®ãƒªã‚¹ãƒˆã‚’è¿”ã™
    """
    csv_file = 'search_history.csv'
    if os.path.exists(csv_file):
        try:
            # CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§èª­ã¿è¾¼ã¿
            df = pd.read_csv(csv_file, encoding='utf-8-sig')
            
            # CSVã‹ã‚‰è¾æ›¸ã®ãƒªã‚¹ãƒˆã«å¤‰æ›
            history_list = []
            for _, row in df.iterrows():
                # paramsã‚«ãƒ©ãƒ ã‚’JSONã‹ã‚‰è¾æ›¸ã«å¤‰æ›
                params_str = row.get('params', '{}')
                try:
                    params = json.loads(params_str) if isinstance(params_str, str) else params_str
                except json.JSONDecodeError:
                    # JSONè§£æã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ç©ºã®è¾æ›¸ã‚’ä½¿ç”¨
                    params = {}
                
                # å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
                history_item = {
                    'timestamp': row.get('timestamp', ''),
                    'params': params,
                    'results_count': row.get('results_count', 0)
                }
                history_list.append(history_item)
            
            st.success(f"âœ… æ¤œç´¢å±¥æ­´ã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ{len(history_list)}ä»¶ï¼‰")
            return history_list
            
        except Exception as e:
            st.warning(f"âš ï¸ æ¤œç´¢å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
            return []
    else:
        st.info("â„¹ï¸ æ¤œç´¢å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„å±¥æ­´ã‹ã‚‰é–‹å§‹ã—ã¾ã™ã€‚")
        return []

# =============================================================================
# ãƒ¡ã‚¤ãƒ³é–¢æ•°
# =============================================================================

def main():
    """
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
    
    æ©Ÿèƒ½:
    - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
    - æ¤œç´¢å±¥æ­´ã®èª­ã¿è¾¼ã¿
    - ãƒšãƒ¼ã‚¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    - ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ç®¡ç†
    
    ãƒ•ãƒ­ãƒ¼:
    1. æ¤œç´¢å±¥æ­´ã®åˆæœŸåŒ–
    2. ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤º
    3. ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤º
    4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    5. ãƒšãƒ¼ã‚¸åˆ†å²å‡¦ç†
    """
    
    # =====================================================================
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ–
    # =====================================================================
    
    # æ¤œç´¢å±¥æ­´ã‚’CSVã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆåˆå›ã®ã¿ï¼‰
    if 'search_history' not in st.session_state:
        st.session_state.search_history = load_search_history()
    
    # =====================================================================
    # ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤º
    # =====================================================================
    
    st.markdown('<h1 class="main-header">ğŸ›ï¸ å›½ä¼šè­°äº‹éŒ²æ¤œç´¢ãƒ»åˆ†æã‚¢ãƒ—ãƒª</h1>', unsafe_allow_html=True)
    
    # =====================================================================
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤ºã¨ãƒšãƒ¼ã‚¸é¸æŠ
    # =====================================================================
    
    page = show_sidebar()
    
    # =====================================================================
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    # =====================================================================
    
    app = KokkaiSearchApp()
    
    # =====================================================================
    # ãƒšãƒ¼ã‚¸åˆ†å²å‡¦ç†
    # =====================================================================
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‹ã‚‰ãƒšãƒ¼ã‚¸ã‚’å–å¾—ï¼ˆå†æ¤œç´¢æ™‚ã®è‡ªå‹•ç§»å‹•ç”¨ï¼‰
    current_page = st.session_state.get('current_page', page)
    
    # ãƒšãƒ¼ã‚¸ã«å¿œã˜ãŸå‡¦ç†ã®åˆ†å²
    if current_page == "ğŸ” æ¤œç´¢":
        st.info("ğŸ” æ¤œç´¢ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™...")
        app.search_page()
        
    elif current_page == "ğŸ“Š åˆ†æ":
        st.info("ğŸ“Š åˆ†æãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™...")
        app.analysis_page()
        
    elif current_page == "ğŸ›ï¸ ä¼šè­°åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ":
        # Janomeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
        try:
            from janome.tokenizer import Tokenizer
            st.info("ğŸ›ï¸ ä¼šè­°åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™...")
            app.meeting_analysis_page()
        except ImportError:
            st.error("âŒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†ææ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚Janomeãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
            st.info("ğŸ’¡ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†ææ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯: pip install janome")
            # æ¤œç´¢ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            st.session_state['current_page'] = "ğŸ” æ¤œç´¢"
            st.rerun()
        
    elif current_page == "ğŸ“š æ¤œç´¢å±¥æ­´":
        st.info("ğŸ“š æ¤œç´¢å±¥æ­´ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™...")
        app.history_page()
        
    else:
        st.info("â„¹ï¸ ãƒ˜ãƒ«ãƒ—ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™...")
        app.help_page()

# =============================================================================
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
# =============================================================================

if __name__ == "__main__":
    """
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
    
    å®Ÿè¡Œæ–¹æ³•:
    - ç›´æ¥å®Ÿè¡Œ: python main.py
    - Streamlitå®Ÿè¡Œ: streamlit run main.py
    
    æ³¨æ„äº‹é …:
    - Streamlitã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æ¨å¥¨
    - ãƒ‡ãƒãƒƒã‚°æ™‚ã¯ç›´æ¥å®Ÿè¡Œã‚‚å¯èƒ½
    """
    main()
